<!-- File: index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pond Volume Calculator</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(18,28,51,.92);
      --line:rgba(38,54,87,.75);
      --txt:#e7eefc;
      --muted:#a8b7d6;
      --btn:#1f5eff;
      --btn2:#2a3a5e;
      --good:#00e676;
      --bad:#ff5252;
      --shadow:0 12px 35px rgba(0,0,0,.28);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(31,94,255,.18), transparent 60%),
                 radial-gradient(900px 500px at 90% 10%, rgba(0,230,118,.10), transparent 55%),
                 linear-gradient(160deg,#070c16,#0b1220 45%,#070c16);
      color:var(--txt);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:18px}

    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{display:flex;flex-direction:column;gap:6px}
    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .subtitle{margin:0;color:var(--muted);max-width:900px;line-height:1.35}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:rgba(11,20,40,.35);
      padding:6px 10px;border-radius:999px;
    }

    /* 3 columns */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:16px;
      align-items:start;
    }
    @media(max-width:1200px){ .grid{grid-template-columns:1fr 1fr} }
    @media(max-width:820px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h2{margin:0 0 10px;font-size:15px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hr{height:1px;background:var(--line);margin:14px 0;opacity:.75}

    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input,select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#0b1428;
      color:var(--txt);
    }
    input:focus,select:focus{border-color:rgba(31,94,255,.85); box-shadow:0 0 0 3px rgba(31,94,255,.18)}
    .grid2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:520px){ .grid2{grid-template-columns:1fr} }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      border:0;
      padding:11px 13px;
      border-radius:14px;
      background:var(--btn);
      color:white;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 10px 22px rgba(31,94,255,.20);
    }
    button:hover{filter:brightness(1.05)}
    #btnReset{background:var(--btn2);box-shadow:none}

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(11,20,40,.45);
      color:var(--muted);
      line-height:1.35;
    }

    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    @media(max-width:1200px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    @media(max-width:980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:520px){ .kpis{grid-template-columns:1fr} }

    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(11,20,40,.35);
    }
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:16px;font-weight:900;margin-top:6px}
    .pass{color:var(--good)}
    .fail{color:var(--bad)}

    .splitHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(11,20,40,.35);
    }

    /* Sketch */
    .sketchWrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(11,20,40,.35);
      padding:10px;
      overflow:hidden;
    }
    .sketchNote{margin:8px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    svg{width:100%;height:auto;display:block}
    .svgtxt{font-family:system-ui,Segoe UI,Roboto,Arial}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Pond Volume Calculator</h1>
        <p class="subtitle">
          3-column layout: <b>Inputs</b> → <b>Results</b> → <b>3D Sketch</b>.
          You enter <b>upper dimensions at Max WL</b>; the calculator derives <b>lower (bottom) dimensions</b> from depth and side slope.
        </p>
        <div class="pillrow">
          <span class="pill">Upper dims → bottom dims</span>
          <span class="pill">SCS / Inflow / Direct volume</span>
          <span class="pill">Auto “Increase pond dimension” check</span>
        </div>
      </div>
      <div class="pillrow">
        <span class="pill">Units: m, m³</span>
        <span class="pill">Side slope Z:1 (H:V)</span>
      </div>
    </div>

    <div class="grid">
      <!-- 1) INPUTS -->
      <div class="card">
        <div class="splitHead">
          <h2>Inputs</h2>
          <span class="tag">Upper Dimensions Mode</span>
        </div>

        <div class="hr"></div>

        <h2>1) Required Volume Method</h2>
        <div class="row">
          <div style="flex:2">
            <label>Method</label>
            <select id="mode">
              <option value="scs" selected>SCS Runoff Volume (Area + CN + Storm Depth)</option>
              <option value="inflow">Storm Inflow Volume (Triangular Qp/Tp/Tb)</option>
              <option value="vol">Direct Stormwater Volume (User Input m³)</option>
            </select>
          </div>
        </div>

        <div id="scsBox" class="grid2">
          <div>
            <label>Drainage Area (ha)</label>
            <input id="areaHa" type="number" step="0.1" value="20" min="0.01">
          </div>
          <div>
            <label>Curve Number (CN)</label>
            <input id="cn" type="number" step="1" value="85" min="30" max="98">
          </div>
          <div>
            <label>Storm Depth P (mm)</label>
            <input id="pmm" type="number" step="1" value="50" min="0">
          </div>
          <div>
            <label>Loss factor (optional, %)</label>
            <input id="lossPct" type="number" step="1" value="0" min="0" max="50">
          </div>
        </div>

        <div id="inflowBox" class="grid2" style="display:none">
          <div>
            <label>Peak inflow Qp (m³/s)</label>
            <input id="qp" type="number" step="0.01" value="1.2" min="0">
          </div>
          <div>
            <label>Time to peak Tp (min)</label>
            <input id="tp" type="number" step="1" value="45" min="1">
          </div>
          <div>
            <label>Base duration Tb (min)</label>
            <input id="tb" type="number" step="1" value="180" min="1">
          </div>
          <div>
            <label>Loss factor (optional, %)</label>
            <input id="lossPct2" type="number" step="1" value="0" min="0" max="50">
          </div>
        </div>

        <div id="volBox" class="grid2" style="display:none">
          <div>
            <label>Required Stormwater Volume (m³)</label>
            <input id="vreqUser" type="number" step="1" value="500" min="0">
          </div>
          <div>
            <label>Loss factor (optional, %)</label>
            <input id="lossPct3" type="number" step="1" value="0" min="0" max="50">
          </div>
        </div>

        <div class="hr"></div>

        <h2>2) Levels</h2>
        <div class="grid2">
          <div>
            <label>Ground / Crest Level (EGL) (m)</label>
            <input id="egl" type="number" step="0.01" value="10.00">
          </div>
          <div>
            <label>Pipe Invert Level (IL) (m)</label>
            <input id="il" type="number" step="0.01" value="8.00">
          </div>
          <div>
            <label>Depth below IL (m) (min 0.30)</label>
            <input id="belowIL" type="number" step="0.01" value="0.30" min="0.30">
          </div>
          <div>
            <label>Freeboard (m)</label>
            <input id="fb" type="number" step="0.01" value="0.30" min="0">
          </div>
        </div>
        <p class="muted small" style="margin:8px 0 0">Bottom = IL − depthBelowIL. Max WL = EGL − freeboard.</p>

        <div class="hr"></div>

        <h2>3) Geometry (Upper dims input)</h2>
        <div class="row">
          <div style="flex:2">
            <label>Shape</label>
            <select id="shape">
              <option value="rect" selected>Rectangular (Upper L/W @ Max WL)</option>
              <option value="circ">Circular (Upper Diameter @ Max WL)</option>
            </select>
          </div>
        </div>

        <div id="rectBox" class="grid2">
          <div>
            <label>Upper Length @ Max WL (m)</label>
            <input id="ltop" type="number" step="0.1" value="50" min="0.1">
          </div>
          <div>
            <label>Upper Width @ Max WL (m)</label>
            <input id="wtop" type="number" step="0.1" value="40" min="0.1">
          </div>
          <div>
            <label>Side slope Z:1 (H:V)</label>
            <input id="z" type="number" step="0.1" value="3" min="0">
          </div>
          <div>
            <label class="muted">Bottom dims</label>
            <input disabled value="Auto-calculated">
          </div>
        </div>

        <div id="circBox" class="grid2" style="display:none">
          <div>
            <label>Upper Diameter @ Max WL (m)</label>
            <input id="dtop" type="number" step="0.1" value="40" min="0.1">
          </div>
          <div>
            <label>Side slope Z:1 (H:V)</label>
            <input id="zc" type="number" step="0.1" value="3" min="0">
          </div>
          <div>
            <label class="muted">Bottom diameter</label>
            <input disabled value="Auto-calculated">
          </div>
          <div></div>
        </div>

        <div class="btnrow">
          <button id="run">CALCULATE</button>
          <button id="btnReset" type="button">RESET EXAMPLE</button>
        </div>

        <div id="msg" class="msg">Ready.</div>
      </div>

      <!-- 2) RESULTS -->
      <div class="card">
        <div class="splitHead">
          <h2>Results</h2>
          <span id="statusTag" class="tag">—</span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="t">Pond Bottom (m)</div><div id="kBottom" class="v">–</div></div>
          <div class="kpi"><div class="t">Max Water Level (m)</div><div id="kMaxWL" class="v">–</div></div>
          <div class="kpi"><div class="t">Available Depth (m)</div><div id="kDepth" class="v">–</div></div>
          <div class="kpi"><div class="t">Freeboard (m)</div><div id="kFB" class="v">–</div></div>

          <div class="kpi"><div class="t">Upper Length @ Max WL (m)</div><div id="kTopL" class="v">–</div></div>
          <div class="kpi"><div class="t">Upper Width @ Max WL (m)</div><div id="kTopW" class="v">–</div></div>

          <div class="kpi"><div class="t">Lower Length (Bottom) (m)</div><div id="kLowL" class="v">–</div></div>
          <div class="kpi"><div class="t">Lower Width (Bottom) (m)</div><div id="kLowW" class="v">–</div></div>

          <div class="kpi"><div class="t">Upper Diameter @ Max WL (m)</div><div id="kTopD" class="v">–</div></div>
          <div class="kpi"><div class="t">Lower Diameter (Bottom) (m)</div><div id="kLowD" class="v">–</div></div>

          <div class="kpi"><div class="t">Total Storage @ Max WL (m³)</div><div id="kVtot" class="v">–</div></div>
          <div class="kpi"><div class="t">Storage Below IL (m³)</div><div id="kVbelow" class="v">–</div></div>
          <div class="kpi"><div class="t">Storage IL → Max WL (m³)</div><div id="kVactive" class="v">–</div></div>

          <div class="kpi"><div class="t">Required Volume (m³)</div><div id="kVreq" class="v">–</div></div>
          <div class="kpi"><div class="t">Storage Check</div><div id="kPass" class="v">–</div></div>
          <div class="kpi"><div class="t">Note</div><div id="kNote" class="v">–</div></div>
        </div>

        <div class="hr"></div>

        <p class="muted small" style="margin:0">
          Rectangular: <b>Lb = Ltop − 2·Z·H</b>, <b>Wb = Wtop − 2·Z·H</b><br>
          Circular: <b>Dbottom = Dtop − 2·Z·H</b><br>
          If any lower dimension ≤ 0 → <b>Increase the pond dimension</b>
        </p>
      </div>

      <!-- 3) SKETCH -->
      <div class="card">
        <div class="splitHead">
          <h2>3D Sketch (Clear Dimensions)</h2>
          <span class="tag">Illustrative</span>
        </div>

        <div class="sketchWrap">
          <svg id="pondSketch" viewBox="0 0 980 640" role="img" aria-label="Pond sketch">
            <defs>
              <linearGradient id="soil" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="rgba(231,238,252,.14)"/>
                <stop offset="1" stop-color="rgba(231,238,252,.05)"/>
              </linearGradient>
              <linearGradient id="water" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="rgba(31,94,255,.55)"/>
                <stop offset="1" stop-color="rgba(31,94,255,.18)"/>
              </linearGradient>
            </defs>

            <rect x="12" y="12" width="956" height="616" rx="18" fill="rgba(11,20,40,.22)" stroke="rgba(38,54,87,.9)" stroke-width="2"></rect>

            <g id="gDraw"></g>

            <g class="svgtxt" font-size="13" fill="rgba(168,183,214,.95)">
              <circle cx="44" cy="600" r="6" fill="rgba(31,94,255,.55)"></circle>
              <text x="60" y="605">Water</text>
              <rect x="128" y="594" width="12" height="12" fill="url(#soil)" stroke="rgba(231,238,252,.15)"></rect>
              <text x="148" y="605">Pond Body</text>
              <line x1="250" y1="600" x2="280" y2="600" stroke="rgba(255,255,255,.55)" stroke-width="2"></line>
              <text x="290" y="605">Level/Dimension lines</text>
            </g>
          </svg>
          <div class="sketchNote">
            Sketch shows: EGL, Max WL, IL, Bottom, Freeboard, Depth (H) and clear <b>Upper/Lower Length & Width</b> like a simple 3D model.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const fmt = (x,d=2)=> (isFinite(x)? Number(x).toFixed(d):"–");

  function clampPct(x){ x = Number(x); return Math.min(Math.max(isFinite(x)?x:0,0),50); }

  function scsRunoffMm(Pmm, CN){
    const S_in = (1000/CN) - 10;
    const S_mm = S_in * 25.4;
    const Ia = 0.2 * S_mm;
    if(Pmm <= Ia) return 0;
    return Math.max(0, ((Pmm - Ia)**2) / (Pmm + 0.8*S_mm));
  }

  function pondVolumeRect(Lb, Wb, Z, H){
    return (Lb*Wb*H) + (Z*(Lb+Wb)*H*H) + ((4/3)*Z*Z*H*H*H);
  }
  function pondVolumeCirc(r0, Z, H){
    return Math.PI*(r0*r0*H + r0*Z*H*H + (Z*Z/3)*H*H*H);
  }

  function toggleMode(){
    const m = $("mode").value;
    $("scsBox").style.display    = (m==="scs") ? "grid" : "none";
    $("inflowBox").style.display = (m==="inflow") ? "grid" : "none";
    $("volBox").style.display    = (m==="vol") ? "grid" : "none";
  }
  function toggleShape(){
    const s = $("shape").value;
    $("rectBox").style.display = (s==="rect") ? "grid" : "none";
    $("circBox").style.display = (s==="circ") ? "grid" : "none";
    safeSketchFromInputs();
  }

  function setStatus(pass, text){
    const tag = $("statusTag");
    if(text) tag.textContent = text;
    tag.style.borderColor = pass===true ? "rgba(0,230,118,.45)" : pass===false ? "rgba(255,82,82,.45)" : "rgba(38,54,87,.75)";
    tag.style.color = pass===true ? "rgba(0,230,118,.95)" : pass===false ? "rgba(255,82,82,.95)" : "rgba(168,183,214,.92)";
    tag.style.background = pass===true ? "rgba(0,230,118,.08)" : pass===false ? "rgba(255,82,82,.08)" : "rgba(11,20,40,.35)";
  }

  function setPassColor(isPass){
    const el = $("kPass");
    el.classList.remove("pass","fail");
    if(isPass === true) el.classList.add("pass");
    if(isPass === false) el.classList.add("fail");
  }

  function setMsg(txt){ $("msg").textContent = txt; }

  // ---------- SVG Helpers ----------
  function svgText(x,y,txt,size=14,fill="rgba(231,238,252,.92)",anchor="start"){
    return `<text class="svgtxt" x="${x}" y="${y}" font-size="${size}" fill="${fill}" text-anchor="${anchor}">${escapeXml(txt)}</text>`;
  }
  function escapeXml(s){
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function svgLine(x1,y1,x2,y2,stroke="rgba(255,255,255,.55)",w=2,dash=false){
    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${stroke}" stroke-width="${w}" ${dash ? 'stroke-dasharray="8 6"' : ""}/>`;
  }
  function svgRect(x,y,w,h,rx=10,fill="rgba(11,20,40,.65)",stroke="rgba(38,54,87,.85)"){
    return `<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${rx}" fill="${fill}" stroke="${stroke}"/>`;
  }
  function dimArrow(p1, p2, label, opts={}){
    const {color="rgba(231,238,252,.75)", textBg=true} = opts;
    const x1=p1.x, y1=p1.y, x2=p2.x, y2=p2.y;
    const dx=x2-x1, dy=y2-y1;
    const len=Math.hypot(dx,dy) || 1;
    const ux=dx/len, uy=dy/len;
    const nx=-uy, ny=ux;
    const ah=10; // arrow head size

    const a1 = {x:x1+ux*ah, y:y1+uy*ah};
    const a2 = {x:x2-ux*ah, y:y2-uy*ah};

    const head1 = [
      {x:x1, y:y1},
      {x:x1+ux*ah+nx*6, y:y1+uy*ah+ny*6},
      {x:x1+ux*ah-nx*6, y:y1+uy*ah-ny*6},
    ];
    const head2 = [
      {x:x2, y:y2},
      {x:x2-ux*ah+nx*6, y:y2-uy*ah+ny*6},
      {x:x2-ux*ah-nx*6, y:y2-uy*ah-ny*6},
    ];

    const mid = {x:(x1+x2)/2, y:(y1+y2)/2};
    const tx = mid.x + nx*14;
    const ty = mid.y + ny*14;

    const lblW = Math.max(120, label.length*7.2);
    const lblH = 22;
    const bx = tx - lblW/2;
    const by = ty - 16;

    return `
      <g class="svgtxt">
        ${svgLine(a1.x,a1.y,a2.x,a2.y,color,2,false)}
        <polygon points="${head1.map(p=>`${p.x},${p.y}`).join(" ")}" fill="${color}"></polygon>
        <polygon points="${head2.map(p=>`${p.x},${p.y}`).join(" ")}" fill="${color}"></polygon>
        ${textBg ? svgRect(bx,by,lblW,lblH,10,"rgba(11,20,40,.68)","rgba(38,54,87,.85)") : ""}
        ${svgText(tx,ty,label,13,"rgba(231,238,252,.92)","middle")}
      </g>
    `;
  }

  function levelLine(y, label, color, dash){
    const w = Math.max(130, label.length*7.2);
    return `
      <g class="svgtxt">
        ${svgLine(60,y,920,y,color,2,dash)}
        ${svgRect(60,y-18,w,22,10,"rgba(11,20,40,.68)","rgba(38,54,87,.85)")}
        ${svgText(72,y-2,label,13,"rgba(231,238,252,.92)")}
      </g>
    `;
  }

  // ---------- 3D Sketch Draw (Rect) ----------
  function mapSpan(m){ // meters -> pixels (separate mapping for clarity)
    const v = Math.max(0, Number(m));
    return Math.max(60, Math.min(360, 90 + v*4.8));
  }

  function drawSketchRect3D(params){
    const g = $("gDraw");
    const {
      egl, maxWL, il, bottom, fb, H,
      Ltop, Wtop, Lb, Wb, Z
    } = params;

    // Vertical mapper (levels)
    const yTop = 90, yBot = 540;
    const elevMax = egl;
    const elevMin = bottom;
    const mapY = (e)=>{
      if(elevMax === elevMin) return yBot;
      const t = (elevMax - e) / (elevMax - elevMin);
      return yTop + t*(yBot - yTop);
    };
    const yEGL = mapY(egl);
    const yMax = mapY(maxWL);
    const yIL  = mapY(il);
    const yBtm = mapY(bottom);

    // 3D box-frustum (isometric-ish)
    const cx = 640, cy = 320;           // center of model
    const lift = 120;                    // vertical lift for top face
    const off = {x:90, y:-60};           // perspective offset for top face

    const topLenPx = mapSpan(Ltop);
    const topWidPx = mapSpan(Wtop);
    const botLenPx = mapSpan(Lb);
    const botWidPx = mapSpan(Wb);

    // Bottom face (rectangle centered at cx,cy+110)
    const bcy = cy + 130;
    const bot = {
      A:{x:cx - botLenPx/2, y:bcy - botWidPx/2},
      B:{x:cx + botLenPx/2, y:bcy - botWidPx/2},
      C:{x:cx + botLenPx/2, y:bcy + botWidPx/2},
      D:{x:cx - botLenPx/2, y:bcy + botWidPx/2},
    };

    // Top face (offset + lifted)
    const tcy = bcy - lift;
    const top = {
      A:{x:(cx - topLenPx/2) + off.x, y:(tcy - topWidPx/2) + off.y},
      B:{x:(cx + topLenPx/2) + off.x, y:(tcy - topWidPx/2) + off.y},
      C:{x:(cx + topLenPx/2) + off.x, y:(tcy + topWidPx/2) + off.y},
      D:{x:(cx - topLenPx/2) + off.x, y:(tcy + topWidPx/2) + off.y},
    };

    // Water plane (at Max WL): show as translucent top face
    // (since user inputs upper dims @ MaxWL, water aligns to top face)
    const pondBody = `
      <g>
        <!-- sides -->
        <polygon points="${top.A.x},${top.A.y} ${top.B.x},${top.B.y} ${bot.B.x},${bot.B.y} ${bot.A.x},${bot.A.y}"
          fill="url(#soil)" stroke="rgba(231,238,252,.22)" stroke-width="2"/>
        <polygon points="${top.B.x},${top.B.y} ${top.C.x},${top.C.y} ${bot.C.x},${bot.C.y} ${bot.B.x},${bot.B.y}"
          fill="url(#soil)" stroke="rgba(231,238,252,.18)" stroke-width="2"/>
        <polygon points="${top.C.x},${top.C.y} ${top.D.x},${top.D.y} ${bot.D.x},${bot.D.y} ${bot.C.x},${bot.C.y}"
          fill="rgba(231,238,252,.06)" stroke="rgba(231,238,252,.16)" stroke-width="2"/>
        <polygon points="${top.D.x},${top.D.y} ${top.A.x},${top.A.y} ${bot.A.x},${bot.A.y} ${bot.D.x},${bot.D.y}"
          fill="rgba(231,238,252,.05)" stroke="rgba(231,238,252,.14)" stroke-width="2"/>

        <!-- bottom outline -->
        <polygon points="${bot.A.x},${bot.A.y} ${bot.B.x},${bot.B.y} ${bot.C.x},${bot.C.y} ${bot.D.x},${bot.D.y}"
          fill="rgba(0,0,0,0)" stroke="rgba(231,238,252,.18)" stroke-width="2"/>

        <!-- water (top) -->
        <polygon points="${top.A.x},${top.A.y} ${top.B.x},${top.B.y} ${top.C.x},${top.C.y} ${top.D.x},${top.D.y}"
          fill="url(#water)" stroke="rgba(31,94,255,.55)" stroke-width="2" opacity="0.95"/>
      </g>
    `;

    // Dimension arrows (Upper L, Upper W, Lower L, Lower W)
    // Upper Length: top A->B
    const dUpperL = dimArrow(top.A, top.B, `Upper Length = ${fmt(Ltop,2)} m`);
    // Upper Width: top B->C (right edge)
    const dUpperW = dimArrow(top.B, top.C, `Upper Width = ${fmt(Wtop,2)} m`);

    // Lower Length: bot A->B
    const dLowerL = dimArrow(bot.A, bot.B, `Lower Length = ${fmt(Lb,2)} m`, {color:"rgba(231,238,252,.70)"});
    // Lower Width: bot B->C
    const dLowerW = dimArrow(bot.B, bot.C, `Lower Width = ${fmt(Wb,2)} m`, {color:"rgba(231,238,252,.70)"});

    // Level ruler lines
    const lev =
      levelLine(yEGL, `EGL = ${fmt(egl,2)} m`, "rgba(255,255,255,.55)", true) +
      levelLine(yMax, `Max WL = ${fmt(maxWL,2)} m`, "rgba(31,94,255,.95)", false) +
      levelLine(yIL,  `IL = ${fmt(il,2)} m`, "rgba(0,230,118,.85)", true) +
      levelLine(yBtm, `Bottom = ${fmt(bottom,2)} m`, "rgba(231,238,252,.55)", true);

    // Depth + Freeboard arrows on right side
    const depthArrow = dimArrow({x:940,y:yMax},{x:940,y:yBtm}, `Depth H = ${fmt(H,2)} m`, {color:"rgba(231,238,252,.78)"});
    const fbArrow = dimArrow({x:900,y:yEGL},{x:900,y:yMax}, `Freeboard = ${fmt(fb,2)} m`, {color:"rgba(231,238,252,.60)"});

    const title = `
      <g class="svgtxt">
        ${svgText(60,58,`Rectangular Pond (3D)  •  Side slope Z:1 = ${fmt(Z,2)}:1`,15,"rgba(231,238,252,.92)")}
      </g>
    `;

    g.innerHTML = title + lev + pondBody + dUpperL + dUpperW + dLowerL + dLowerW + depthArrow + fbArrow;
  }

  // ---------- 3D Sketch Draw (Circular / Conical) ----------
  function drawSketchCirc3D(params){
    const g = $("gDraw");
    const {
      egl, maxWL, il, bottom, fb, H,
      Dtop, Dbottom, Z
    } = params;

    const yTop = 90, yBot = 540;
    const elevMax = egl;
    const elevMin = bottom;
    const mapY = (e)=>{
      if(elevMax === elevMin) return yBot;
      const t = (elevMax - e) / (elevMax - elevMin);
      return yTop + t*(yBot - yTop);
    };
    const yEGL = mapY(egl);
    const yMax = mapY(maxWL);
    const yIL  = mapY(il);
    const yBtm = mapY(bottom);

    const cx = 660, cy = 330;
    const lift = 130;
    const off = {x:95, y:-65};

    const topDiaPx = mapSpan(Dtop);
    const botDiaPx = mapSpan(Dbottom);

    const bcy = cy + 130;
    const tcy = bcy - lift;

    // Draw as frustum using ellipses + side quads
    const bot = {x:cx, y:bcy, rx:botDiaPx/2, ry:(botDiaPx/2)*0.28};
    const top = {x:cx+off.x, y:tcy+off.y, rx:topDiaPx/2, ry:(topDiaPx/2)*0.28};

    const body = `
      <g>
        <!-- side shape (approx) -->
        <path d="
          M ${top.x-top.rx} ${top.y}
          C ${top.x-top.rx} ${top.y+top.ry} ${top.x+top.rx} ${top.y+top.ry} ${top.x+top.rx} ${top.y}
          L ${bot.x+bot.rx} ${bot.y}
          C ${bot.x+bot.rx} ${bot.y+bot.ry} ${bot.x-bot.rx} ${bot.y+bot.ry} ${bot.x-bot.rx} ${bot.y}
          Z"
          fill="url(#soil)" stroke="rgba(231,238,252,.22)" stroke-width="2"/>

        <!-- bottom ellipse outline -->
        <ellipse cx="${bot.x}" cy="${bot.y}" rx="${bot.rx}" ry="${bot.ry}"
          fill="rgba(0,0,0,0)" stroke="rgba(231,238,252,.18)" stroke-width="2"/>

        <!-- water (top ellipse) -->
        <ellipse cx="${top.x}" cy="${top.y}" rx="${top.rx}" ry="${top.ry}"
          fill="url(#water)" stroke="rgba(31,94,255,.55)" stroke-width="2" opacity="0.95"/>

        <!-- top ellipse rim -->
        <ellipse cx="${top.x}" cy="${top.y}" rx="${top.rx}" ry="${top.ry}"
          fill="rgba(0,0,0,0)" stroke="rgba(231,238,252,.22)" stroke-width="2"/>
      </g>
    `;

    // Diameter dimension arrows
    const topLeft = {x:top.x-top.rx, y:top.y};
    const topRight= {x:top.x+top.rx, y:top.y};
    const botLeft = {x:bot.x-bot.rx, y:bot.y};
    const botRight= {x:bot.x+bot.rx, y:bot.y};

    const dTop = dimArrow(topLeft, topRight, `Upper Diameter = ${fmt(Dtop,2)} m`);
    const dBot = dimArrow(botLeft, botRight, `Lower Diameter = ${fmt(Dbottom,2)} m`, {color:"rgba(231,238,252,.70)"});

    const lev =
      levelLine(yEGL, `EGL = ${fmt(egl,2)} m`, "rgba(255,255,255,.55)", true) +
      levelLine(yMax, `Max WL = ${fmt(maxWL,2)} m`, "rgba(31,94,255,.95)", false) +
      levelLine(yIL,  `IL = ${fmt(il,2)} m`, "rgba(0,230,118,.85)", true) +
      levelLine(yBtm, `Bottom = ${fmt(bottom,2)} m`, "rgba(231,238,252,.55)", true);

    const depthArrow = dimArrow({x:940,y:yMax},{x:940,y:yBtm}, `Depth H = ${fmt(H,2)} m`, {color:"rgba(231,238,252,.78)"});
    const fbArrow = dimArrow({x:900,y:yEGL},{x:900,y:yMax}, `Freeboard = ${fmt(fb,2)} m`, {color:"rgba(231,238,252,.60)"});

    const title = `
      <g class="svgtxt">
        ${svgText(60,58,`Circular Pond (3D)  •  Side slope Z:1 = ${fmt(Z,2)}:1`,15,"rgba(231,238,252,.92)")}
      </g>
    `;

    g.innerHTML = title + lev + body + dTop + dBot + depthArrow + fbArrow;
  }

  // ---------- Live Sketch (best effort) ----------
  function safeSketchFromInputs(){
    const egl = Number($("egl").value);
    const il  = Number($("il").value);
    const below = Math.max(Number($("belowIL").value), 0.30);
    const fb  = Number($("fb").value);

    if(!isFinite(egl)||!isFinite(il)||!isFinite(below)||!isFinite(fb)){
      $("gDraw").innerHTML = "";
      return;
    }

    const bottom = il - below;
    const maxWL = egl - fb;
    const H = maxWL - bottom;
    if(!(H>0)){
      $("gDraw").innerHTML = "";
      return;
    }

    const shape = $("shape").value;
    if(shape === "rect"){
      const Ltop = Number($("ltop").value);
      const Wtop = Number($("wtop").value);
      const Z = Number($("z").value);
      if(!(isFinite(Ltop)&&isFinite(Wtop)&&isFinite(Z))) return;

      const Lb = Ltop - 2*Z*H;
      const Wb = Wtop - 2*Z*H;

      drawSketchRect3D({
        egl, maxWL, il, bottom, fb, H,
        Ltop, Wtop,
        Lb: isFinite(Lb)?Math.max(Lb,0):0,
        Wb: isFinite(Wb)?Math.max(Wb,0):0,
        Z
      });
    } else {
      const Dtop = Number($("dtop").value);
      const Z = Number($("zc").value);
      if(!(isFinite(Dtop)&&isFinite(Z))) return;

      const Dbottom = Dtop - 2*Z*H;

      drawSketchCirc3D({
        egl, maxWL, il, bottom, fb, H,
        Dtop,
        Dbottom: isFinite(Dbottom)?Math.max(Dbottom,0):0,
        Z
      });
    }
  }

  // ---------- CALC ----------
  function calc(){
    try{
      const egl = Number($("egl").value);
      const il  = Number($("il").value);
      let below = Number($("belowIL").value);
      const fb  = Number($("fb").value);

      if(!isFinite(egl)||!isFinite(il)||!isFinite(below)||!isFinite(fb)) throw new Error("Check levels inputs.");
      if(below < 0.30) below = 0.30;
      $("belowIL").value = below.toFixed(2);

      const bottom = il - below;
      const maxWL  = egl - fb;
      const H = maxWL - bottom;
      if(!(H>0)) throw new Error("Invalid levels: (EGL - Freeboard) must be above (IL - Depth below IL).");

      const shape = $("shape").value;

      let Vtot = 0, Vbelow = 0;
      let topL = NaN, topW = NaN, topD = NaN;
      let lowL = NaN, lowW = NaN, lowD = NaN;
      let Z = NaN;

      if(shape === "rect"){
        topL = Number($("ltop").value);
        topW = Number($("wtop").value);
        Z  = Number($("z").value);

        if(!(topL>0 && topW>0 && Z>=0)) throw new Error("Check rectangular upper dimensions and side slope.");

        lowL = topL - 2*Z*H;
        lowW = topW - 2*Z*H;

        if(!(lowL > 0 && lowW > 0)){
          throw new Error("Increase the pond dimension (upper L/W too small for this depth and side slope).");
        }

        Vtot = pondVolumeRect(lowL, lowW, Z, H);

        const Hbelow = Math.max(0, il - bottom);
        if(Hbelow > 0){
          const hUse = Math.min(Hbelow, H);
          Vbelow = pondVolumeRect(lowL, lowW, Z, hUse);
        }

        drawSketchRect3D({egl, maxWL, il, bottom, fb, H, Ltop:topL, Wtop:topW, Lb:lowL, Wb:lowW, Z});
      } else {
        topD = Number($("dtop").value);
        Z  = Number($("zc").value);

        if(!(topD>0 && Z>=0)) throw new Error("Check circular upper diameter and side slope.");

        lowD = topD - 2*Z*H;
        if(!(lowD > 0)){
          throw new Error("Increase the pond dimension (upper diameter too small for this depth and side slope).");
        }

        const r0 = lowD/2;
        Vtot = pondVolumeCirc(r0, Z, H);

        const Hbelow = Math.max(0, il - bottom);
        if(Hbelow > 0){
          const hUse = Math.min(Hbelow, H);
          Vbelow = pondVolumeCirc(r0, Z, hUse);
        }

        drawSketchCirc3D({egl, maxWL, il, bottom, fb, H, Dtop:topD, Dbottom:lowD, Z});
      }

      const Vactive = Math.max(0, Vtot - Vbelow);

      // Required volume
      const mode = $("mode").value;
      let Vreq = 0;
      let note = "";

      if(mode==="scs"){
        const areaHa = Number($("areaHa").value);
        const cn = Number($("cn").value);
        const pmm = Number($("pmm").value);
        const loss = clampPct($("lossPct").value);

        if(!(areaHa>0 && cn>=30 && cn<=98 && pmm>=0)) throw new Error("Check SCS inputs.");

        const qmm = scsRunoffMm(pmm, cn);
        const areaM2 = areaHa * 10000;
        Vreq = (qmm/1000) * areaM2;
        Vreq *= (1 - loss/100);
        note = `SCS runoff depth ≈ ${fmt(qmm,1)} mm (loss ${fmt(loss,0)}%)`;
      }
      else if(mode==="inflow"){
        const Qp = Number($("qp").value);
        const Tp = Number($("tp").value);
        const Tb = Number($("tb").value);
        const loss = clampPct($("lossPct2").value);

        if(!(Qp>=0 && Tp>0 && Tb>0 && Tb>=Tp)) throw new Error("Check inflow inputs (Tb ≥ Tp).");

        Vreq = 0.5 * Qp * (Tb*60);
        Vreq *= (1 - loss/100);
        note = `Triangular inflow volume from Qp & Tb (loss ${fmt(loss,0)}%)`;
      }
      else {
        const vuser = Number($("vreqUser").value);
        const loss = clampPct($("lossPct3").value);

        if(!(vuser>=0)) throw new Error("Enter a valid required volume (m³).");
        Vreq = vuser * (1 - loss/100);
        note = `Direct required volume (loss ${fmt(loss,0)}%)`;
      }

      const pass = (Vtot >= Vreq);

      // KPIs
      $("kBottom").textContent = fmt(bottom,2);
      $("kMaxWL").textContent = fmt(maxWL,2);
      $("kDepth").textContent  = fmt(H,2);
      $("kFB").textContent = fmt(fb,2);

      $("kTopL").textContent = isFinite(topL) ? fmt(topL,2) : "–";
      $("kTopW").textContent = isFinite(topW) ? fmt(topW,2) : "–";
      $("kTopD").textContent = isFinite(topD) ? fmt(topD,2) : "–";

      $("kLowL").textContent = isFinite(lowL) ? fmt(lowL,2) : "–";
      $("kLowW").textContent = isFinite(lowW) ? fmt(lowW,2) : "–";
      $("kLowD").textContent = isFinite(lowD) ? fmt(lowD,2) : "–";

      $("kVtot").textContent   = fmt(Vtot,0);
      $("kVbelow").textContent = fmt(Vbelow,0);
      $("kVactive").textContent= fmt(Vactive,0);

      $("kVreq").textContent   = fmt(Vreq,0);
      $("kPass").textContent   = pass ? "PASS" : "FAIL";
      setPassColor(pass);

      $("kNote").textContent   = note;

      if(pass){
        setMsg(`PASS: Storage @ Max WL (${fmt(Vtot,0)} m³) ≥ required (${fmt(Vreq,0)} m³).`);
        setStatus(true, "PASS");
      } else {
        setMsg(`FAIL: Storage @ Max WL (${fmt(Vtot,0)} m³) < required (${fmt(Vreq,0)} m³). Increase pond size/depth or revise assumptions.`);
        setStatus(false, "FAIL");
      }

    } catch(e){
      setMsg(e.message || String(e));
      $("kPass").textContent = "–";
      $("kPass").classList.remove("pass","fail");
      setStatus(null, "—");
      safeSketchFromInputs();
    }
  }

  function resetExample(){
    $("mode").value = "scs";
    $("areaHa").value = 20;
    $("cn").value = 85;
    $("pmm").value = 50;
    $("lossPct").value = 0;

    $("qp").value = 1.2;
    $("tp").value = 45;
    $("tb").value = 180;
    $("lossPct2").value = 0;

    $("vreqUser").value = 500;
    $("lossPct3").value = 0;

    $("egl").value = 10.00;
    $("il").value = 8.00;
    $("belowIL").value = 0.30;
    $("fb").value = 0.30;

    $("shape").value = "rect";
    $("ltop").value = 50;
    $("wtop").value = 40;
    $("z").value = 3;

    $("dtop").value = 40;
    $("zc").value = 3;

    toggleMode();
    toggleShape();
    setMsg("Ready. Adjust inputs then click CALCULATE.");
    setStatus(null, "—");
    safeSketchFromInputs();
  }

  function bindLiveSketch(){
    const ids = [
      "egl","il","belowIL","fb",
      "shape","ltop","wtop","z","dtop","zc"
    ];
    ids.forEach(id=>{
      $(id).addEventListener("input", safeSketchFromInputs);
      $(id).addEventListener("change", safeSketchFromInputs);
    });
  }

  // Events
  $("mode").addEventListener("change", toggleMode);
  $("shape").addEventListener("change", toggleShape);
  $("run").addEventListener("click", calc);
  $("btnReset").addEventListener("click", resetExample);

  // Init
  toggleMode();
  toggleShape();
  bindLiveSketch();
  safeSketchFromInputs();
  setStatus(null, "—");
  setMsg("Ready. Adjust inputs then click CALCULATE.");
</script>
</body>
</html>
