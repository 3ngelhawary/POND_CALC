<!-- File: index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pond Volume Calculator</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(18,28,51,.92);
      --line:rgba(38,54,87,.75);
      --txt:#e7eefc;
      --muted:#a8b7d6;
      --btn:#1f5eff;
      --btn2:#2a3a5e;
      --good:#00e676;
      --bad:#ff5252;
      --shadow:0 12px 35px rgba(0,0,0,.28);
      --radius:16px;

      --berm:#2f7dff;     /* Berm dims */
      --bottom:#16c784;   /* Bottom dims */
      --wl:#b45cff;       /* Max WL dims */
      --levels:#ff9f1a;   /* Levels lines */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:radial-gradient(1100px 520px at 15% 0%, rgba(47,125,255,.18), transparent 60%),
                 radial-gradient(900px 500px at 90% 12%, rgba(22,199,132,.10), transparent 55%),
                 linear-gradient(160deg,#070c16,#0b1220 45%,#070c16);
      color:var(--txt);
    }
    .wrap{max-width:1450px;margin:0 auto;padding:18px}

    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .subtitle{margin:6px 0 0;color:var(--muted);max-width:1100px;line-height:1.35}

    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:start}
    @media(max-width:1200px){ .grid{grid-template-columns:1fr 1fr} }
    @media(max-width:820px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h2{margin:0 0 10px;font-size:15px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:14px 0;opacity:.75}

    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input,select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#0b1428;
      color:var(--txt);
    }
    input:focus,select:focus{border-color:rgba(31,94,255,.85); box-shadow:0 0 0 3px rgba(31,94,255,.18)}
    .grid2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:520px){ .grid2{grid-template-columns:1fr} }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{
      border:0;
      padding:11px 13px;
      border-radius:14px;
      background:var(--btn);
      color:white;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 10px 22px rgba(31,94,255,.20);
    }
    button:hover{filter:brightness(1.05)}
    #btnReset{background:var(--btn2);box-shadow:none}

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(11,20,40,.45);
      color:var(--muted);
      line-height:1.35;
    }

    .splitHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(11,20,40,.35);
    }

    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    @media(max-width:1200px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    @media(max-width:980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:520px){ .kpis{grid-template-columns:1fr} }

    .kpi{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:rgba(11,20,40,.35)}
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:16px;font-weight:900;margin-top:6px}

    .kpiBerm .v{color:var(--berm)}
    .kpiBottom .v{color:var(--bottom)}
    .kpiWL .v{color:var(--wl)}

    .pass{color:var(--good)}
    .fail{color:var(--bad)}

    /* Graph */
    .graphWrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(11,20,40,.25);
      padding:12px;
    }
    .legendRow{
      display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 0;
      color:var(--muted);font-size:12px
    }
    .chip{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(11,20,40,.35)}
    .dot{width:10px;height:10px;border-radius:50%}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Pond Volume Calculator</h1>
        <div class="subtitle"><b>Upper Length/Width</b> are at <b>Berm Level (EGL)</b>. Bottom dimensions are derived using <b>Depth Bottom → EGL</b>. Storage is computed up to <b>Max WL = EGL − Freeboard</b>.</div>
      </div>
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <div class="splitHead">
          <h2>Inputs</h2>
          <span class="tag">Upper = Berm @ EGL</span>
        </div>

        <div class="hr"></div>

        <h2>1) Required Volume</h2>
        <div class="row">
          <div style="flex:2">
            <label>Method</label>
            <select id="mode">
              <option value="scs" selected>SCS Runoff Volume</option>
              <option value="inflow">Storm Inflow Volume (Triangular)</option>
              <option value="vol">Direct Stormwater Volume (m³)</option>
            </select>
          </div>
        </div>

        <div id="scsBox" class="grid2">
          <div>
            <label>Drainage Area (ha)</label>
            <input id="areaHa" type="number" step="0.1" value="20" min="0.01">
          </div>
          <div>
            <label>Curve Number (CN)</label>
            <input id="cn" type="number" step="1" value="85" min="30" max="98">
          </div>
          <div>
            <label>Storm Depth P (mm)</label>
            <input id="pmm" type="number" step="1" value="50" min="0">
          </div>
          <div>
            <label>Loss factor (optional, %)</label>
            <input id="lossPct" type="number" step="1" value="0" min="0" max="50">
          </div>
        </div>

        <div id="inflowBox" class="grid2" style="display:none">
          <div>
            <label>Peak inflow Qp (m³/s)</label>
            <input id="qp" type="number" step="0.01" value="1.2" min="0">
          </div>
          <div>
            <label>Time to peak Tp (min)</label>
            <input id="tp" type="number" step="1" value="45" min="1">
          </div>
          <div>
            <label>Base duration Tb (min)</label>
            <input id="tb" type="number" step="1" value="180" min="1">
          </div>
          <div>
            <label>Loss factor (optional, %)</label>
            <input id="lossPct2" type="number" step="1" value="0" min="0" max="50">
          </div>
        </div>

        <div id="volBox" class="grid2" style="display:none">
          <div>
            <label>Required Stormwater Volume (m³)</label>
            <input id="vreqUser" type="number" step="1" value="500" min="0">
          </div>
          <div>
            <label>Loss factor (optional, %)</label>
            <input id="lossPct3" type="number" step="1" value="0" min="0" max="50">
          </div>
        </div>

        <div class="hr"></div>

        <h2>2) Levels</h2>
        <div class="grid2">
          <div>
            <label>Ground / Berm Level (EGL) (m)</label>
            <input id="egl" type="number" step="0.01" value="10.00">
          </div>
          <div>
            <label>Pipe Invert Level (IL) (m)</label>
            <input id="il" type="number" step="0.01" value="8.00">
          </div>
          <div>
            <label>Depth below IL (m) (min 0.30)</label>
            <input id="belowIL" type="number" step="0.01" value="0.30" min="0.30">
          </div>
          <div>
            <label>Freeboard (m)</label>
            <input id="fb" type="number" step="0.01" value="0.30" min="0">
          </div>
        </div>

        <div class="hr"></div>

        <h2>3) Geometry</h2>
        <div class="row">
          <div style="flex:2">
            <label>Shape</label>
            <select id="shape">
              <option value="rect" selected>Rectangular</option>
              <option value="circ">Circular</option>
            </select>
          </div>
        </div>

        <div id="rectBox" class="grid2">
          <div>
            <label>Upper Length @ Berm (EGL) (m)</label>
            <input id="ltop" type="number" step="0.1" value="50" min="0.1">
          </div>
          <div>
            <label>Upper Width @ Berm (EGL) (m)</label>
            <input id="wtop" type="number" step="0.1" value="40" min="0.1">
          </div>
          <div>
            <label>Side slope Z:1 (H:V)</label>
            <input id="z" type="number" step="0.1" value="3" min="0">
          </div>
          <div>
            <label class="muted">Bottom dims</label>
            <input disabled value="Auto-calculated">
          </div>
        </div>

        <div id="circBox" class="grid2" style="display:none">
          <div>
            <label>Upper Diameter @ Berm (EGL) (m)</label>
            <input id="dtop" type="number" step="0.1" value="40" min="0.1">
          </div>
          <div>
            <label>Side slope Z:1 (H:V)</label>
            <input id="zc" type="number" step="0.1" value="3" min="0">
          </div>
          <div>
            <label class="muted">Bottom diameter</label>
            <input disabled value="Auto-calculated">
          </div>
          <div></div>
        </div>

        <div class="btnrow">
          <button id="run">CALCULATE</button>
          <button id="btnReset" type="button">RESET</button>
        </div>

        <div id="msg" class="msg">Ready.</div>
      </div>

      <!-- RESULTS -->
      <div class="card">
        <div class="splitHead">
          <h2>Results</h2>
          <span id="statusTag" class="tag">—</span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="t">Pond Bottom Level (m)</div><div id="kBottom" class="v">–</div></div>
          <div class="kpi"><div class="t">Max Water Level (m)</div><div id="kMaxWL" class="v">–</div></div>
          <div class="kpi"><div class="t">Depth Bottom → EGL (m)</div><div id="kHEGL" class="v">–</div></div>
          <div class="kpi"><div class="t">Depth Bottom → Max WL (m)</div><div id="kHWL" class="v">–</div></div>

          <div class="kpi kpiBerm"><div class="t">Upper Length @ Berm (m)</div><div id="kTopL" class="v">–</div></div>
          <div class="kpi kpiBerm"><div class="t">Upper Width @ Berm (m)</div><div id="kTopW" class="v">–</div></div>

          <div class="kpi kpiWL"><div class="t">Length @ Max WL (m)</div><div id="kWLL" class="v">–</div></div>
          <div class="kpi kpiWL"><div class="t">Width @ Max WL (m)</div><div id="kWLW" class="v">–</div></div>

          <div class="kpi kpiBottom"><div class="t">Lower Length (Bottom) (m)</div><div id="kLowL" class="v">–</div></div>
          <div class="kpi kpiBottom"><div class="t">Lower Width (Bottom) (m)</div><div id="kLowW" class="v">–</div></div>

          <div class="kpi kpiBerm"><div class="t">Upper Diameter @ Berm (m)</div><div id="kTopD" class="v">–</div></div>
          <div class="kpi kpiBottom"><div class="t">Lower Diameter (Bottom) (m)</div><div id="kLowD" class="v">–</div></div>

          <div class="kpi"><div class="t">Total Storage @ Max WL (m³)</div><div id="kVtot" class="v">–</div></div>
          <div class="kpi"><div class="t">Storage Below IL (m³)</div><div id="kVbelow" class="v">–</div></div>
          <div class="kpi"><div class="t">Storage IL → Max WL (m³)</div><div id="kVactive" class="v">–</div></div>

          <div class="kpi"><div class="t">Required Volume (m³)</div><div id="kVreq" class="v">–</div></div>
          <div class="kpi"><div class="t">Storage Check</div><div id="kPass" class="v">–</div></div>
          <div class="kpi"><div class="t">Freeboard (m)</div><div id="kFB" class="v">–</div></div>
        </div>
      </div>

      <!-- GRAPH -->
      <div class="card">
        <div class="splitHead">
          <h2>Graph</h2>
          <span class="tag">Dimensions vs Elevation</span>
        </div>

        <div class="graphWrap">
          <canvas id="chartGeom" height="420"></canvas>

          <div class="legendRow">
            <div class="chip"><span class="dot" style="background:var(--berm)"></span> Berm (EGL)</div>
            <div class="chip"><span class="dot" style="background:var(--wl)"></span> Max WL</div>
            <div class="chip"><span class="dot" style="background:var(--bottom)"></span> Bottom</div>
            <div class="chip"><span class="dot" style="background:var(--levels)"></span> Level Lines</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  const $ = id => document.getElementById(id);
  const fmt = (x,d=2)=> (isFinite(x)? Number(x).toFixed(d):"–");
  function clampPct(x){ x = Number(x); return Math.min(Math.max(isFinite(x)?x:0,0),50); }

  function scsRunoffMm(Pmm, CN){
    const S_in = (1000/CN) - 10;
    const S_mm = S_in * 25.4;
    const Ia = 0.2 * S_mm;
    if(Pmm <= Ia) return 0;
    return Math.max(0, ((Pmm - Ia)**2) / (Pmm + 0.8*S_mm));
  }

  function pondVolumeRect(Lb, Wb, Z, H){
    return (Lb*Wb*H) + (Z*(Lb+Wb)*H*H) + ((4/3)*Z*Z*H*H*H);
  }
  function pondVolumeCirc(r0, Z, H){
    return Math.PI*(r0*r0*H + r0*Z*H*H + (Z*Z/3)*H*H*H);
  }

  function toggleMode(){
    const m = $("mode").value;
    $("scsBox").style.display    = (m==="scs") ? "grid" : "none";
    $("inflowBox").style.display = (m==="inflow") ? "grid" : "none";
    $("volBox").style.display    = (m==="vol") ? "grid" : "none";
  }
  function toggleShape(){
    const s = $("shape").value;
    $("rectBox").style.display = (s==="rect") ? "grid" : "none";
    $("circBox").style.display = (s==="circ") ? "grid" : "none";
    updateGraphFromInputs();
  }

  function setStatus(pass, text){
    const tag = $("statusTag");
    tag.textContent = text || "—";
    tag.style.borderColor = pass===true ? "rgba(0,230,118,.45)" : pass===false ? "rgba(255,82,82,.45)" : "rgba(38,54,87,.75)";
    tag.style.color = pass===true ? "rgba(0,230,118,.95)" : pass===false ? "rgba(255,82,82,.95)" : "rgba(168,183,214,.92)";
    tag.style.background = pass===true ? "rgba(0,230,118,.08)" : pass===false ? "rgba(255,82,82,.08)" : "rgba(11,20,40,.35)";
  }
  function setPassColor(isPass){
    const el = $("kPass");
    el.classList.remove("pass","fail");
    if(isPass === true) el.classList.add("pass");
    if(isPass === false) el.classList.add("fail");
  }
  function setMsg(txt){ $("msg").textContent = txt; }

  // ---------------- GRAPH ----------------
  let chartGeom = null;

  function asPoint(x,y){ return {x, y}; }

  function makeHLine(y, xMin, xMax){
    return [asPoint(xMin,y), asPoint(xMax,y)];
  }

  function buildGraphDataRect(levels, dims){
    // y = elevation (m), x = dimension (m)
    const {bottom, il, maxWL, egl} = levels;
    const {Lb, Wb, Lwl, Wwl, Lberm, Wberm} = dims;

    const xMax = Math.max(Lberm, Wberm, Lwl, Wwl, Lb, Wb) * 1.15;
    const xMin = 0;

    const lenLine = [
      asPoint(Lb, bottom),
      asPoint(Lwl, maxWL),
      asPoint(Lberm, egl),
    ];
    const widLine = [
      asPoint(Wb, bottom),
      asPoint(Wwl, maxWL),
      asPoint(Wberm, egl),
    ];

    const lvlIL   = makeHLine(il, xMin, xMax);
    const lvlMax  = makeHLine(maxWL, xMin, xMax);
    const lvlEGL  = makeHLine(egl, xMin, xMax);
    const lvlBot  = makeHLine(bottom, xMin, xMax);

    return {xMin,xMax, lenLine, widLine, lvlIL, lvlMax, lvlEGL, lvlBot};
  }

  function buildGraphDataCirc(levels, dims){
    const {bottom, il, maxWL, egl} = levels;
    const {Db, Dwl, Dberm} = dims;

    const xMax = Math.max(Dberm, Dwl, Db) * 1.20;
    const xMin = 0;

    const diaLine = [
      asPoint(Db, bottom),
      asPoint(Dwl, maxWL),
      asPoint(Dberm, egl),
    ];

    const lvlIL   = makeHLine(il, xMin, xMax);
    const lvlMax  = makeHLine(maxWL, xMin, xMax);
    const lvlEGL  = makeHLine(egl, xMin, xMax);
    const lvlBot  = makeHLine(bottom, xMin, xMax);

    return {xMin,xMax, diaLine, lvlIL, lvlMax, lvlEGL, lvlBot};
  }

  function ensureChart(){
    const ctx = $("chartGeom").getContext("2d");
    if(chartGeom) return;

    chartGeom = new Chart(ctx, {
      type: "scatter",
      data: { datasets: [] },
      options: {
        responsive: true,
        animation: false,
        parsing: false,
        plugins: {
          legend: { labels: { color: "#e7eefc", font: { size: 14, weight: "700" } } },
          tooltip: {
            callbacks: {
              label: (c) => {
                const x = c.raw?.x, y = c.raw?.y;
                return `${c.dataset.label}: ${fmt(x,2)} m @ Elev ${fmt(y,2)} m`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: "Dimension (m)", color: "#a8b7d6", font: { size: 14, weight:"800" } },
            ticks: { color: "#a8b7d6" },
            grid: { color: "rgba(38,54,87,.35)" }
          },
          y: {
            title: { display: true, text: "Elevation (m)", color: "#a8b7d6", font: { size: 14, weight:"800" } },
            ticks: { color: "#a8b7d6" },
            grid: { color: "rgba(38,54,87,.35)" }
          }
        }
      }
    });
  }

  function setChartRange(xMin, xMax, yMin, yMax){
    chartGeom.options.scales.x.min = xMin;
    chartGeom.options.scales.x.max = xMax;
    chartGeom.options.scales.y.min = yMin;
    chartGeom.options.scales.y.max = yMax;
  }

  function updateChartDatasets(datasets){
    chartGeom.data.datasets = datasets;
    chartGeom.update();
  }

  function updateGraphFromInputs(){
    try{
      ensureChart();

      const egl = Number($("egl").value);
      const il  = Number($("il").value);
      const below = Math.max(Number($("belowIL").value), 0.30);
      const fb  = Number($("fb").value);

      if(!isFinite(egl)||!isFinite(il)||!isFinite(below)||!isFinite(fb)) throw new Error("bad");

      const bottom = il - below;
      const maxWL = egl - fb;

      const H_EGL = egl - bottom;
      const H_WL  = maxWL - bottom;
      if(!(H_EGL>0 && H_WL>0 && H_EGL>=H_WL)) throw new Error("bad");

      const yMin = bottom - 0.15*(egl-bottom);
      const yMax = egl + 0.10*(egl-bottom);

      const shape = $("shape").value;

      if(shape === "rect"){
        const Lberm = Number($("ltop").value);
        const Wberm = Number($("wtop").value);
        const Z = Number($("z").value);
        if(!(Lberm>0 && Wberm>0 && Z>=0)) throw new Error("bad");

        const Lb = Lberm - 2*Z*H_EGL;
        const Wb = Wberm - 2*Z*H_EGL;
        if(!(Lb>0 && Wb>0)) throw new Error("dim");

        const Lwl = Lb + 2*Z*H_WL;
        const Wwl = Wb + 2*Z*H_WL;

        const gd = buildGraphDataRect(
          {bottom, il, maxWL, egl},
          {Lb,Wb,Lwl,Wwl,Lberm,Wberm}
        );

        setChartRange(gd.xMin, gd.xMax, yMin, yMax);

        updateChartDatasets([
          {
            label: "Length",
            data: gd.lenLine,
            showLine: true,
            borderWidth: 5,
            pointRadius: 6
          },
          {
            label: "Width",
            data: gd.widLine,
            showLine: true,
            borderWidth: 5,
            pointRadius: 6
          },
          { label: "EGL (Berm)", data: gd.lvlEGL, showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
          { label: "Max WL",      data: gd.lvlMax, showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
          { label: "IL",          data: gd.lvlIL,  showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
          { label: "Bottom",      data: gd.lvlBot, showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
        ]);

        // force colors (Chart.js default colors are fine, but we want strong)
        chartGeom.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue("--berm").trim();
        chartGeom.data.datasets[0].backgroundColor = chartGeom.data.datasets[0].borderColor;

        chartGeom.data.datasets[1].borderColor = getComputedStyle(document.documentElement).getPropertyValue("--wl").trim();
        chartGeom.data.datasets[1].backgroundColor = chartGeom.data.datasets[1].borderColor;

        const lvlCol = getComputedStyle(document.documentElement).getPropertyValue("--levels").trim();
        for(let i=2;i<6;i++){
          chartGeom.data.datasets[i].borderColor = lvlCol;
        }
        chartGeom.update();
      } else {
        const Dberm = Number($("dtop").value);
        const Z = Number($("zc").value);
        if(!(Dberm>0 && Z>=0)) throw new Error("bad");

        const Db = Dberm - 2*Z*H_EGL;
        if(!(Db>0)) throw new Error("dim");

        const Dwl = Db + 2*Z*H_WL;

        const gd = buildGraphDataCirc(
          {bottom, il, maxWL, egl},
          {Db, Dwl, Dberm}
        );

        setChartRange(gd.xMin, gd.xMax, yMin, yMax);

        updateChartDatasets([
          {
            label: "Diameter",
            data: gd.diaLine,
            showLine: true,
            borderWidth: 5,
            pointRadius: 6
          },
          { label: "EGL (Berm)", data: gd.lvlEGL, showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
          { label: "Max WL",      data: gd.lvlMax, showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
          { label: "IL",          data: gd.lvlIL,  showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
          { label: "Bottom",      data: gd.lvlBot, showLine:true, borderWidth:4, pointRadius:0, borderDash:[10,8] },
        ]);

        chartGeom.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue("--berm").trim();
        chartGeom.data.datasets[0].backgroundColor = chartGeom.data.datasets[0].borderColor;

        const lvlCol = getComputedStyle(document.documentElement).getPropertyValue("--levels").trim();
        for(let i=1;i<5;i++){
          chartGeom.data.datasets[i].borderColor = lvlCol;
        }
        chartGeom.update();
      }

    } catch(e){
      if(chartGeom){
        chartGeom.data.datasets = [];
        chartGeom.update();
      }
    }
  }

  // ---------------- CALC ----------------
  function calc(){
    try{
      const egl = Number($("egl").value);
      const il  = Number($("il").value);
      let below = Number($("belowIL").value);
      const fb  = Number($("fb").value);

      if(!isFinite(egl)||!isFinite(il)||!isFinite(below)||!isFinite(fb)) throw new Error("Check levels inputs.");
      if(below < 0.30) below = 0.30;
      $("belowIL").value = below.toFixed(2);

      const bottom = il - below;
      const maxWL  = egl - fb;

      const H_EGL = egl - bottom;     // for bottom dims
      const H_WL  = maxWL - bottom;   // for storage up to max WL
      if(!(H_EGL>0 && H_WL>0 && H_EGL>=H_WL)) throw new Error("Invalid levels.");

      const shape = $("shape").value;

      let Vtot=0, Vbelow=0;
      let Lberm=NaN, Wberm=NaN, Lb=NaN, Wb=NaN, Lwl=NaN, Wwl=NaN;
      let Dberm=NaN, Db=NaN, Dwl=NaN;
      let Z=NaN;

      if(shape === "rect"){
        Lberm = Number($("ltop").value);
        Wberm = Number($("wtop").value);
        Z = Number($("z").value);
        if(!(Lberm>0 && Wberm>0 && Z>=0)) throw new Error("Check berm dimensions and side slope.");

        Lb = Lberm - 2*Z*H_EGL;
        Wb = Wberm - 2*Z*H_EGL;
        if(!(Lb > 0 && Wb > 0)) throw new Error("Increase the pond dimension.");

        Lwl = Lb + 2*Z*H_WL;
        Wwl = Wb + 2*Z*H_WL;

        Vtot = pondVolumeRect(Lb, Wb, Z, H_WL);

        const Hbelow = Math.max(0, il - bottom);
        if(Hbelow > 0){
          const hUse = Math.min(Hbelow, H_WL);
          Vbelow = pondVolumeRect(Lb, Wb, Z, hUse);
        }
      } else {
        Dberm = Number($("dtop").value);
        Z = Number($("zc").value);
        if(!(Dberm>0 && Z>=0)) throw new Error("Check berm diameter and side slope.");

        Db = Dberm - 2*Z*H_EGL;
        if(!(Db > 0)) throw new Error("Increase the pond dimension.");

        Dwl = Db + 2*Z*H_WL;

        const r0 = Db/2;
        Vtot = pondVolumeCirc(r0, Z, H_WL);

        const Hbelow = Math.max(0, il - bottom);
        if(Hbelow > 0){
          const hUse = Math.min(Hbelow, H_WL);
          Vbelow = pondVolumeCirc(r0, Z, hUse);
        }
      }

      const Vactive = Math.max(0, Vtot - Vbelow);

      // Required volume
      const mode = $("mode").value;
      let Vreq = 0;

      if(mode==="scs"){
        const areaHa = Number($("areaHa").value);
        const cn = Number($("cn").value);
        const pmm = Number($("pmm").value);
        const loss = clampPct($("lossPct").value);
        if(!(areaHa>0 && cn>=30 && cn<=98 && pmm>=0)) throw new Error("Check SCS inputs.");

        const qmm = scsRunoffMm(pmm, cn);
        const areaM2 = areaHa * 10000;
        Vreq = (qmm/1000) * areaM2;
        Vreq *= (1 - loss/100);
      }
      else if(mode==="inflow"){
        const Qp = Number($("qp").value);
        const Tp = Number($("tp").value);
        const Tb = Number($("tb").value);
        const loss = clampPct($("lossPct2").value);
        if(!(Qp>=0 && Tp>0 && Tb>0 && Tb>=Tp)) throw new Error("Check inflow inputs (Tb ≥ Tp).");

        Vreq = 0.5 * Qp * (Tb*60);
        Vreq *= (1 - loss/100);
      }
      else {
        const vuser = Number($("vreqUser").value);
        const loss = clampPct($("lossPct3").value);
        if(!(vuser>=0)) throw new Error("Enter a valid required volume (m³).");

        Vreq = vuser * (1 - loss/100);
      }

      const pass = (Vtot >= Vreq);

      // KPIs
      $("kBottom").textContent = fmt(bottom,2);
      $("kMaxWL").textContent  = fmt(maxWL,2);
      $("kHEGL").textContent   = fmt(H_EGL,2);
      $("kHWL").textContent    = fmt(H_WL,2);
      $("kFB").textContent     = fmt(fb,2);

      $("kTopL").textContent = isFinite(Lberm) ? fmt(Lberm,2) : "–";
      $("kTopW").textContent = isFinite(Wberm) ? fmt(Wberm,2) : "–";
      $("kWLL").textContent  = isFinite(Lwl)   ? fmt(Lwl,2)   : "–";
      $("kWLW").textContent  = isFinite(Wwl)   ? fmt(Wwl,2)   : "–";
      $("kLowL").textContent = isFinite(Lb)    ? fmt(Lb,2)    : "–";
      $("kLowW").textContent = isFinite(Wb)    ? fmt(Wb,2)    : "–";

      $("kTopD").textContent = isFinite(Dberm) ? fmt(Dberm,2) : "–";
      $("kLowD").textContent = isFinite(Db)    ? fmt(Db,2)    : "–";

      $("kVtot").textContent   = fmt(Vtot,0);
      $("kVbelow").textContent = fmt(Vbelow,0);
      $("kVactive").textContent= fmt(Vactive,0);

      $("kVreq").textContent   = fmt(Vreq,0);
      $("kPass").textContent   = pass ? "PASS" : "FAIL";
      setPassColor(pass);

      if(pass){
        setMsg("PASS: Pond storage at max WL is ≥ required volume.");
        setStatus(true, "PASS");
      } else {
        setMsg("FAIL: Increase pond size/depth or revise assumptions.");
        setStatus(false, "FAIL");
      }

      updateGraphFromInputs();

    } catch(e){
      setMsg(e.message || String(e));
      $("kPass").textContent = "–";
      $("kPass").classList.remove("pass","fail");
      setStatus(null, "—");
      updateGraphFromInputs();
    }
  }

  function resetExample(){
    $("mode").value = "scs";
    $("areaHa").value = 20;
    $("cn").value = 85;
    $("pmm").value = 50;
    $("lossPct").value = 0;

    $("qp").value = 1.2;
    $("tp").value = 45;
    $("tb").value = 180;
    $("lossPct2").value = 0;

    $("vreqUser").value = 500;
    $("lossPct3").value = 0;

    $("egl").value = 10.00;
    $("il").value = 8.00;
    $("belowIL").value = 0.30;
    $("fb").value = 0.30;

    $("shape").value = "rect";
    $("ltop").value = 50;
    $("wtop").value = 40;
    $("z").value = 3;

    $("dtop").value = 40;
    $("zc").value = 3;

    toggleMode();
    toggleShape();
    setMsg("Ready.");
    setStatus(null, "—");
    updateGraphFromInputs();
  }

  function bindLiveGraph(){
    const ids = ["mode","egl","il","belowIL","fb","shape","ltop","wtop","z","dtop","zc"];
    ids.forEach(id=>{
      $(id).addEventListener("input", updateGraphFromInputs);
      $(id).addEventListener("change", updateGraphFromInputs);
    });
  }

  $("mode").addEventListener("change", toggleMode);
  $("shape").addEventListener("change", toggleShape);
  $("run").addEventListener("click", calc);
  $("btnReset").addEventListener("click", resetExample);

  toggleMode();
  toggleShape();
  bindLiveGraph();
  updateGraphFromInputs();
  setStatus(null, "—");
  setMsg("Ready.");
</script>
</body>
</html>
